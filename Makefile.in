# $NetBSD: Makefile.in,v 1.25 2004/08/16 17:24:56 jlam Exp $
#

srcdir=		@srcdir@
prefix= 	@prefix@
VPATH=		@srcdir@
SHELL=		/bin/sh

CC=		@CC@
CFLAGS=		-I$(srcdir) -I. @INCLUDES@ @CFLAGS@
CPPFLAGS=	@CPPFLAGS@
DEFS=		@DEFS@
INSTALL=	@INSTALL@
LDFLAGS=	@LDFLAGS@

AWK=		@AWK@
AR=		@AR@
RANLIB=		@RANLIB@

LIB=		libnbcompat.a

INCS=		nbcompat.h \
		nbcompat/err.h \
		nbcompat/fnmatch.h \
		nbcompat/fts.h \
		nbcompat/getopt.h \
		nbcompat/glob.h \
		nbcompat/grp.h \
		nbcompat/limits.h \
		nbcompat/md5.h \
		nbcompat/nbconfig.h \
		nbcompat/nbtypes.h \
		nbcompat/paths.h \
		nbcompat/poll.h \
		nbcompat/pwd.h \
		nbcompat/queue.h \
		nbcompat/regex.h \
		nbcompat/rmd160.h \
		nbcompat/sha1.h \
		nbcompat/stat.h \
		nbcompat/statvfs.h \
		nbcompat/stdio.h \
		nbcompat/stdlib.h \
		nbcompat/string.h \
		nbcompat/time.h \
		nbcompat/tzfile.h \
		nbcompat/unistd.h \
		nbcompat/util.h \
		nbcompat/vis.h

# always use our local glob() implementation.
OBJS=		glob.o @LIBOBJS@

LINK=		$(CCLD) $(CFLAGS) $(LDFLAGS) -o $@
COMPILE=	$(CC) $(CPPFLAGS) $(CFLAGS)

.PHONY: all install clean distclean

all: nbcompat/nbtypes.h nbcompat/nbconfig.h $(LIB)

.c.o: nbcompat/nbtypes.h
	$(COMPILE) $(DEFS) -c $<

$(LIB): $(OBJS)
	$(AR) cr $@ $(OBJS)
	$(RANLIB) $@

nbcompat/nbconfig.h: nbcompat/config.h
	$(AWK) '							\
		BEGIN { process = 1 }					\
		/NBCOMPAT template section follows\./ { process = 0 }	\
		/^\#[ 	]*define[ 	]+PACKAGE_.*/ { next }		\
		/^\#[ 	]*define[ 	]+/ {				\
			if (process == 1) {				\
				guard = $$0;				\
				sub("^#[ 	]*define[ 	]+", "", guard); \
				sub("[ 	]+.*", "", guard);		\
				print "#ifndef " guard;			\
				print $$0;				\
				print "#endif";				\
				next;					\
			}						\
		}							\
		{ print }						\
	' nbcompat/config.h > $@

nbcompat/nbtypes.h: bits
	./bits $@

bits: bits.c
	$(CC) -o bits bits.c

install:
	$(INSTALL) -m 755 -d $(prefix)/lib
	$(INSTALL) -m 555 ${LIB} $(prefix)/lib
	$(RANLIB) $(prefix)/lib/$(LIB)
	$(INSTALL) -m 755 -d $(prefix)/include
	$(INSTALL) -m 755 -d $(prefix)/include/nbcompat
	@for file in $(INCS); do \
		echo "$(INSTALL) -m 444 $$file $(prefix)/include/$$file"; \
		$(INSTALL) -m 444 $$file $(prefix)/include/$$file; \
	done

clean:
	rm -f *.a *.o bits nbcompat/nbtypes.h nbcompat/nbcompat.h

distclean: clean
	rm -f Makefile config.log config.status configure.lineno
	rm -f nbcompat/config.h nbcompat/nbconfig.h
