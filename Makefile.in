# $NetBSD: Makefile.in,v 1.13 2003/09/03 13:11:13 jlam Exp $
#

srcdir=		@srcdir@
prefix= 	@prefix@
VPATH=		@srcdir@
SHELL=		/bin/sh

CC=		@CC@
CFLAGS=		-I$(srcdir) -I. @INCLUDES@ @CFLAGS@
CPPFLAGS=	@CPPFLAGS@
DEFS=		@DEFS@
INSTALL=	@INSTALL@
LDFLAGS=	@LDFLAGS@

AWK=		@AWK@
AR=		@AR@
RANLIB=		@RANLIB@

LIB=		libnbcompat.a

INCS=		extern.h ftpglob.h getopt.h md5.h mtree.h nbcompat.h \
		nbcompat/err.h nbcompat/fts.h nbcompat/nbtypes.h \
		nbcompat/poll.h nbcompat/statfs.h nbcompat/vis.h \
		pack_dev.h pwcache.h rmd160.h sha1.h sha2.h stat_flags.h \
		util.h

OBJS=		@LIBOBJS@ \
		md5c.o md5hl.o rmd160.o rmd160hl.o sha1.o sha1hl.o \
		sha2.o sha2hl.o setmode.o __fts13.o getid.o misc.o \
		pack_dev.o spec.o setmode.o stat_flags.o pwcache.o \
		getopt_long.o

LINK=		$(CCLD) $(CFLAGS) $(LDFLAGS) -o $@
COMPILE=	$(CC) $(CPPFLAGS) $(CFLAGS)

.PHONY: all install clean distclean

all: nbcompat/nbtypes.h nbcompat/nbconfig.hi $(LIB)

.c.o: nbcompat/nbtypes.h
	$(COMPILE) $(DEFS) -c $<

$(LIB): $(OBJS)
	$(AR) cr $@ $(OBJS)
	$(RANLIB) $@

nbcompat/nbconfig.hi: nbcompat/nbconfig.h
	$(AWK) '							\
		BEGIN { process = 1 }					\
		/NBCOMPAT template section follows\./ { process = 0 }	\
		/^\#[ 	]*define[ 	]+PACKAGE_.*/ { next }		\
		/^\#[ 	]*define[ 	]+/ {				\
			if (process == 1) {				\
				guard = $$0;				\
				sub("^\#[ 	]*define[ 	]+", "", guard); \
				sub("[ 	]+.*", "", guard);		\
				print "\#ifndef " guard;		\
				print $$0;				\
				print "\#endif";			\
				next;					\
			}						\
		}							\
		{ print }						\
	' nbcompat/nbconfig.h > $@

nbcompat/nbtypes.h: bits
	./bits $@

bits: bits.c
	$(CC) -o bits bits.c

install:
	$(INSTALL) -m 555 ${LIB} $(prefix)/lib
	$(RANLIB) $(prefix)/lib/$(LIB)
	$(INSTALL) -m 755 -d $(prefix)/include/libnbcompat
	$(INSTALL) -m 755 -d $(prefix)/include/libnbcompat/nbcompat
	@for file in $(INCS); do \
		echo "$(INSTALL) -m 444 $$file $(prefix)/include/libnbcompat/$$file"; \
		$(INSTALL) -m 444 $$file $(prefix)/include/libnbcompat/$$file; \
	done
	$(INSTALL) -m 444 nbcompat/nbconfig.hi $(prefix)/include/libnbcompat/nbcompat/nbconfig.h

clean:
	rm -f *.a *.o bits nbcompat/nbtypes.h nbcompat/nbcompat.hi

distclean: clean
	rm -f Makefile config.log config.status configure.lineno
	rm -f nbcompat/nbconfig.h
