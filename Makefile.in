# $NetBSD: Makefile.in,v 1.20 2003/09/14 14:41:23 grant Exp $
#

srcdir=		@srcdir@
prefix= 	@prefix@
VPATH=		@srcdir@
SHELL=		/bin/sh

CC=		@CC@
CFLAGS=		-I$(srcdir) -I. @INCLUDES@ @CFLAGS@
CPPFLAGS=	@CPPFLAGS@
DEFS=		@DEFS@
INSTALL=	@INSTALL@
LDFLAGS=	@LDFLAGS@

AWK=		@AWK@
AR=		@AR@
RANLIB=		@RANLIB@

LIB=		libnbcompat.a

INCS=		nbcompat.h nbcompat/err.h nbcompat/fts.h nbcompat/getopt.h \
		nbcompat/glob.h nbcompat/md5.h nbcompat/nbconfig.h \
		nbcompat/nbtypes.h nbcompat/poll.h nbcompat/rmd160.h \
		nbcompat/sha1.h nbcompat/statfs.h nbcompat/vis.h

OBJS=		@LIBOBJS@

LINK=		$(CCLD) $(CFLAGS) $(LDFLAGS) -o $@
COMPILE=	$(CC) $(CPPFLAGS) $(CFLAGS)

.PHONY: all install clean distclean

all: nbcompat/nbtypes.h nbcompat/nbconfig.h $(LIB)

.c.o: nbcompat/nbtypes.h
	$(COMPILE) $(DEFS) -c $<

# Add dummy.o not to become totally empty, which some ld's don't like.
$(LIB): $(OBJS) dummy.o
	@set -x; case "$(OBJS)" in		\
		*.*)	$(AR) cr $@ $(OBJS);;	\
		*)	$(AR) cr $@ dummy.o;;	\
		esac
	$(RANLIB) $@

nbcompat/nbconfig.h: nbcompat/config.h
	$(AWK) '							\
		BEGIN { process = 1 }					\
		/NBCOMPAT template section follows\./ { process = 0 }	\
		/^\#[ 	]*define[ 	]+PACKAGE_.*/ { next }		\
		/^\#[ 	]*define[ 	]+/ {				\
			if (process == 1) {				\
				guard = $$0;				\
				sub("^\#[ 	]*define[ 	]+", "", guard); \
				sub("[ 	]+.*", "", guard);		\
				print "#ifndef " guard;			\
				print $$0;				\
				print "#endif";				\
				next;					\
			}						\
		}							\
		{ print }						\
	' nbcompat/config.h > $@

nbcompat/nbtypes.h: bits
	./bits $@

bits: bits.c
	$(CC) -o bits bits.c

install:
	$(INSTALL) -m 755 -d $(prefix)/lib
	$(INSTALL) -m 555 ${LIB} $(prefix)/lib
	$(RANLIB) $(prefix)/lib/$(LIB)
	$(INSTALL) -m 755 -d $(prefix)/include
	$(INSTALL) -m 755 -d $(prefix)/include/nbcompat
	@for file in $(INCS); do \
		echo "$(INSTALL) -m 444 $$file $(prefix)/include/$$file"; \
		$(INSTALL) -m 444 $$file $(prefix)/include/$$file; \
	done

clean:
	rm -f *.a *.o bits nbcompat/nbtypes.h nbcompat/nbcompat.h

distclean: clean
	rm -f Makefile config.log config.status configure.lineno
	rm -f nbcompat/config.h nbcompat/nbconfig.h
